---
title: "R ve Ku륿ar - Ebird Verilerinin R ile Analizi I"
author: "Mehmet G칬ktu 칐zt칲rk"
format: html
date: 2023-09-27
description: "R ile Ku Verilerinin Analizi"
categories:
  - R
  - gis
  - r-spatial
  - case_study
image: figs/preview.png
---

![](figs/preview.png)

**Merhabalar, blogun ilk yaz캼s캼na ho geldiniz. Temel bilgiler i칞eren yaz캼lar da olacak ancak blog i칞eriklerinin 칞o릇nun bu gibi vaka 칬rneklerinden olu르ca캼n캼 d칲칲n칲yorum. Tak캼ld캼캼n캼z ve anlamad캼캼n캼z yerler olursa l칲tfen yorum yapmaya 칞ekinmeyiniz. Ayr캼ca katk캼lar캼n캼z캼 ve ele릆irilerinizi de bekliyorum. Keyifli okumalar.**

Lisansa ba륿ad캼캼m y캼llarda arazi 칞al캼릀alar캼 i칞in can atan, lablardan ve her t칲rl칲 veri i를nden ka칞an biriydim. Do르y캼 g칬zlemlemeyi; ku ve memeli arazilerine gitmeyi 칞ok seviyor, bu konularda yapaca캼m bilimsel 칞al캼릀alar캼 d칲륿칲yordum. Ancak korkunun ecele faydas캼 yokmu. Do르daki g칬zlemlerimizden anlaml캼 bilgiler 칞캼kartman캼n yolu veriden ge칞iyormu. 游땐 Veriyi, m칲nasebetimiz artt캼k칞a sevmeye ba륿ad캼m. Ama 칬yle zorunluluktan sevmek falan de를l. 캻칞ine girdik칞e ne kadar haz veren bir ura oldu릇nu ke륹ettim. 캻statistik ve veri analizi, rakamlardan ibaret de를l, hayat캼n her yerinde. Onu sevelim, koruyal캼m. :) Neyse laf캼 fazla uzatmadan konuya d칬neyim.

Bu blog yaz캼s캼nda, R programlama dilini kullanarak ku verilerinin nas캼l i륿endi를ni g칬sterece를m. Yaz캼n캼n uzunlu릇 korkutmas캼n! Sadece az캼c캼k bir ilgi ve temel R ile GIS bilgisi yeterli olacak. Ku륿ara ilginiz olmasa bile, bu yaz캼n캼n baz캼 temel mek칙nsal analizleri 칬renmek i칞in faydal캼 olaca캼n캼 d칲칲n칲yorum. Tak캼ld캼캼n캼z her noktada 칞ekinmeden yorum yapabilirsiniz.

Size iki ana soru sunuyorum:

1. T칲rkiye'deki iller baz캼nda ku t칲r칲 칞e를tlili를 nas캼l bir da캼l캼ma sahip?
2. Bilindi를 gibi K캼z캼lcahamam, T칲rkiye'deki en 칬nemli kara akbaba - *Aegypius monachus* pop칲lasyonlar캼ndan birisini bar캼nd캼r캼yor. Bu t칲r칲n, K캼z캼lcahamam il칞e s캼n캼rlar캼 i칞erisinde nas캼l bir da캼l캼m캼 vard캼r? T칲r칲n da캼l캼m캼yla 칞evresel fakt칬rler aras캼ndaki ili륾i **kabaca** nas캼ld캼r?

Bu yaz캼da yaln캼zca birinci soruya odaklanaca캼z. 캻kinci soru i칞in ikinci yaz캼y캼 bekleyiniz l칲tfen. :)

--------------------------------------------------------------------------------

### Yaz캼n캼n Ak캼캼

Yaz캼n캼n genel ak캼캼 a르캼daki gibidir:

1.  Gerekli paketlerin y칲klenmesi
2.  Ku verisinin y칲klenip bu yaz캼 i칞in gerekli olan alt k칲mesinin al캼nmas캼
3.  Ku verisinin mek칙nsall캼릆캼r캼lmas캼
4.  TR il katman캼n캼n y칲klenmesi
5.  Ku verisinin gruplan캼p 칬zetlenmesi
6.  Her bir il s캼n캼r캼 i칞inde kalan t칲r say캼s캼n캼n hesaplanmas캼
7.  Verinin g칬rselle릆irilmesi

### 1. Gerekli paketlerin y칲klenmesi

```{r}
#| echo: false
tibble::tribble(
  ~ Paket, ~ A칞캼klama,
  "tidyverse", "칂o릇nlukla veri manip칲lasyonu ve g칬rselle릆irme 칲zerine paketler i칞eren bir paket koleksiyonu",
  "sf", "Simple Features: Mek칙nsal vekt칬r verileri i륿emek i칞in",
  "rgeoboundaries", "M칲lki idare s캼n캼rlar캼n캼 indirmek i칞in"
) |> knitr::kable()
```

E른r bu paketler kurulu de를lse a르캼daki kod blo릇 ile kurabilirsiniz. Bu kod blo릇, paketi R'a y칲klemeye 칞al캼르cak, e른r y칲kleyemezse kuracakt캼r. E른r kurulumda s캼k캼nt캼 ya르rsan캼z paketlerin d칬k칲mantasyonuna bakabilirsiniz.

```{r}
#| output: false
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("sf")) install.packages("sf")
if (!require("rgeoboundaries")) install.packages("rgeoboundaries")
```

E른r paketler kuruluysa, bu paketleri library() fonksiyonu ile y칲kleyebiliriz.

```{r}
#| warning: false
library(tidyverse) # bircok veri isini kolaylastirmak icin
library(sf) # r'da mekansal vektor verileri islemek icin
library(rgeoboundaries) # tr il sinirlarina erismek icin
```

### 2. Ku verisinin y칲klenip bu yaz캼 i칞in gerekli olan alt k칲mesinin al캼nmas캼

Yaz캼m캼zdaki ilk soruya cevap verebilmek i칞in iki temel veriye ihtiyac캼m캼z var. Bunlar **ku** ve **T칲rkiye'nin il s캼n캼rlar캼** verileri.

Ku verisini [eBird](https://ebird.org) veri taban캼ndan alaca캼z. eBird, T칲rkiye ve d칲nyadaki en kapsaml캼 ku g칬zlem veri taban캼. Ku g칬zlemcileri araziye 칞캼kt캼klar캼nda g칬zlemledikleri ku륿ar캼 bu veri taban캼na kaydediyor, bu 른kilde bilime ve do르 korumaya katk캼 sa륿ayabiliyorlar.

eBird verilerini siteye 칲ye olduktan sonra, en altta, **Bilim** ba륿캼캼 alt캼ndaki **Veri indirme talebi** sayfas캼ndan ya da [{rebird}](https://docs.ropensci.org/rebird/) paketini kullanarak indirebilirsiniz. Ben, site 칲zerinden t칲m T칲rkiye verilerini indirdim.

캻lk ad캼m olarak indirdi를miz eBird verisini R'a y칲kleyelim. Bu veri txt format캼nda oldu릇 i칞in, [{tidyverse}](https://www.tidyverse.org/) paket grubuna ait [read_delim()](https://readr.tidyverse.org/reference/read_delim.html) fonksiyonunu kulland캼k. Base R'daki [read.table()](https://www.rdocumentation.org/packages/utils/versions/3.6.2/topics/read.table) fonksiyonu da bu i i칞in kullan캼labilir. Veri biraz b칲y칲k oldu릇ndan y칲klenmesi ve i륿enmesi biraz zaman alabilir.

```{r}
#| output: false
ebird <- read_delim("./ebird/ebd_TR_relApr-2023.txt")
```

```{r}
print(ebird)
```

Verimizi R'a y칲kledikten sonra [print()](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/print) fonksiyonu ile veri setimizin temel yap캼s캼na bir g칬z att캼k. 2,403,720 g칬zlem (sat캼r) ve 50 de를륾ene (s칲tun) sahip bir tibble kar캼m캼za 칞캼kt캼. tibble, {tidyverse}'e 칬zel klasik data.frame'den daha kullan캼륿캼 bir veri yap캼s캼d캼r. 칐zel bir data.frame diyebiliriz. Ancak bu kadar fazla de를륾enimiz varken print() fonksiyonu yeterince i륿evsel de를l. Verinin b칲y칲k bir k캼sm캼n캼 g칬remiyoruz. Bu sebeple, R'a y칲kledi를miz veri tablosunun t칲m s칲tunlar캼n캼 ve onlar캼n yap캼lar캼n캼 g칬rmek i칞in [glimpse()](https://dplyr.tidyverse.org/reference/glimpse.html) fonksiyonunu kullanaca캼z. Bu fonksiyon, base R'daki [str()](https://www.rdocumentation.org/packages/utils/versions/3.6.2/topics/str) fonksiyonuna benziyor ancak tibble veri yap캼s캼yla kullan캼l캼rken daha sade ve kullan캼륿캼. 칐zetle, bu fonksiyonu, print() fonksiyonunun transpoze edilmi h칙li olarak g칬rebilirsiniz.

```{r}
glimpse(ebird)
```

Bu fonksiyon sayesinde s칲tunlar캼 칞ok daha rahat bir 른kilde g칬rebiliyoruz. G칬rd칲칲n칲z gibi bu yaz캼 i칞in i를mize yaramayacak olan bir s칲r칲 s칲tun var. Kalabal캼kta kaybolmamak i칞in yaln캼zca i를mize yarayabilecek s칲tunlar캼 se칞elim. Ard캼ndan da sadece t칲r kayd캼 olan g칬zlemleri se칞mek i칞in *species*'e g칬re filtreleyelim.

```{r}
ebird_subset <- ebird |>
  select(4, 6, 7, 11, 12, 18, 29, 30) |>  # burada indeks kullanarak sectik, sutun isimleriyle de secebiliriz
  filter(CATEGORY == "species")
ebird_subset
```

```{r}
glimpse(ebird_subset)
```

G칬rd칲칲n칲z gibi verinin i를mize yarayacak bir alt k칲mesini ald캼k, kalabal캼ktan kurtulduk.

Art캼k ilk y칲kledi를miz veriyi (ebird) R'dan silebiliriz. Veri, t칲m TR'yi kapsad캼캼 i칞in 2 milyondan fazla g칬zlem i칞eriyor. B칲y칲k veri setleri RAM'in 를릀esine ve R'캼n 칞칬kmesine sebep olabilir. Bu sebeple art캼k i를mize yaramayacak olan verileri environment'ten kald캼ral캼m.

```{r}
rm(ebird)
```

### 3. Ku verisinin mek칙nsall캼릆캼r캼lmas캼

Ku verisinin ihtiyac캼m캼z olan alt k칲mesini ald캼ktan sonra s캼ra geldi verimizi mek칙nsalla릆캼rmaya. Verimizi, uygun mek칙nsal veri tipine d칬n칲릆칲r칲p, mek칙nsal analizlerde kullan캼labilecek bir h칙le getirece를z. Bunun i칞in, R'da mek칙nsal vekt칬r verileri i륿emek i칞in geli릆irilen [{sf}](https://r-spatial.github.io/sf/) paketini kullanaca캼z.

Lat long verisini ve koordinat sistemini tan캼mlayarak eBird verisini sf objesine d칬n칲릆칲relim.

```{r}
ebird_sf <- st_as_sf(
	ebird_subset, coords = c("LONGITUDE", "LATITUDE"), crs = "EPSG:4326"
)
ebird_sf
```

Verimizi sf format캼na d칬n칲릆칲rd칲칲m칲zde, baz캼 칬nemli mek칙nsal 칬zelliklerin eklenmi oldu릇nu g칬r칲yoruz. Bunlar aras캼nda geometri tipi (POINT), veri boyutu (dimension), verinin corafi s캼n캼rlar캼n캼 tan캼mlayan bounding box koordinatlar캼 ve koordinat referans sistemi (CRS) bulunuyor. Bundan sonra mek칙nsal analizleri rahat칞a yapabiliriz.

Dikkat ederseniz verinin her bir sat캼r캼, bir koordinat 칞iftiyle ili륾ili. Bu, her bir sat캼r캼n ve bu sat캼rdaki t칲m bilgilerin, bir geometriyle ili륾ili oldu릇nu g칬steriyor. Bu geometri de, geometri tipinde belirtildi를 ya da bir koordinat 칞iftinin varl캼캼ndan anlayabilece를miz gibi nokta. Yani 2,298,920 tane noktam캼z var ve her bir nokta bir g칬zlemle ili륾ili.

### 4. TR il katman캼n캼n y칲klenmesi

eBird verisini mek칙nsalla릆캼rd캼캼m캼za g칬re s캼ra geldi TR il s캼n캼rlar캼n캼 R'a y칲klemeye. Ben [geoBoundaries](https://www.geoboundaries.org/) veri taban캼n캼 kullan캼yorum. 캻htiya칞 duydu릇nuz m칲lki idare s캼n캼rlar캼 verisinine eri릀ek i칞in bu linki ya da [{rgeoboundaries}](https://github.com/wmgeolab/rgeoboundaries) paketini kullanabilirsiniz.

```{r}
tr_il <- gb_adm1(country = "Turkey", type = "SSCGS") # type = "SSCGS" argumaniyla basitlestirilmi versiyonunu indiriyoruz
tr_il
```

Base R [plot()](https://www.rdocumentation.org/packages/graphics/versions/3.6.2/topics/plot.default) fonksiyonu ile tr_il objemizi 칞izelim.

```{r}
plot(tr_il)
```

G칬rd칲칲n칲z gibi sf objesi i칞in plot() fonksiyonu, t칲m de를륾enleri (s칲tunlar캼) 칞iziyor. Sadece shapeName de를륾enini se칞ip, eksenleri ve ba륿캼캼 ekleyerek daha iyi bir T칲rkiye il s캼n캼rlar캼 haritas캼 칞izelim.

```{r}
plot(tr_il[, "shapeName"], graticule = TRUE, axes = TRUE, main = "T칲rkiye Haritas캼")
```

Hop! 칂ok daha iyi!

Art캼k ku verimizin T칲rkiye 칲zerindeki da캼l캼m캼n캼 incelemeye ba륿ama vakti geldi. Ancak 2 milyondan fazla sat캼r캼 olan bir verinin grafi를ni 칞izmek muhtemelen R'캼n 칞칬kmesiyle sonu칞lanacakt캼r. Bu y칲zden bu verinin bir alt k칲mesini alal캼m.

```{r}
ebird_sample <- sample_n(ebird_sf, 500000)
```

Veri tablomuzdan rastgele 500000 sat캼r se칞tik. Bu say캼 bilgisayar캼n캼z i칞in fazla geliyorsa 5-10b de se칞ebilirsiniz.

Verimizi, bu sefer de R'캼n vazge칞ilmez paketi olan [{ggplot2}](https://ggplot2.tidyverse.org/) ile g칬rselle릆irelim. ggplot2, 칞izece를miz verileri katman katman belirtip **+** ile birbirine ba륿amam캼za izin veren olduk칞a esnek bir paket. 룔mdi haritam캼z캼 칞izelim.

```{r}
ggplot() +                                       # grafigi baslatiyor
  geom_sf(data = tr_il, aes()) +                 # tr katmanini ekliyoruz
  geom_sf(data = ebird_sample, aes(), size = .5) # kus verimizi ekliyoruz
```

500000 ku g칬zlem verisinin T칲rkiye'deki da캼l캼m캼 bu 른kildeymi. Bu grafi른 dayanarak, 칲lkenin bat캼s캼nda ve b칲y칲k른hirlerde daha 칞ok g칬zlem oldu릇nu s칬yleyebiliriz. Bu genel da캼l캼m캼 g칬rd칲칲m칲ze g칬re merak etti를m 2 t칲r칲n da캼l캼m캼na bakmak istiyorum.  Veriyi t칲r ismine g칬re filtreleyip haritay캼 칞iziyoruz.

#### Sakall캼 Akbaba

![[Album of Abyssinian birds and mammals \| Chicago :Field Museum of Natural History,1930.](https://biodiversitylibrary.org/page/2836721)](figs/bearded.jpg)

Sakall캼 akbaba - _Gypaetus barbatus_, sarp da륿ar캼n insandan uzak k칬른lerinde; genellikle kanyonlar ve derin yarlarda ya르yan bir akbaba t칲r칲. Kendine has g칬r칲n칲칲 ve diyetinin kemikten olu릀as캼 sebebiyle olduk칞a ilgi 칞ekici bir t칲r. Nesli tehdit alt캼ndaki bu nadir t칲r칲n T칲rkiye'deki da캼l캼m캼na bir bakal캼m.

```{r}
sakalli <- ebird_sf |> 
  filter(`SCIENTIFIC NAME` == "Gypaetus barbatus")
```

```{r}
ggplot() +
  geom_sf(data = tr_il, aes()) +
  geom_sf(data = sakalli, aes(), size = .7)
```

G칬rd칲칲n칲z gibi sakall캼 akbaban캼n T칲rkiye'deki da캼l캼m캼 K칬ro륿u Da륿ar캼, Alada륿ar, Ka칞kar Da륿ar캼, Akda gibi da륿캼k alanlarda yo릇nla캼yor.

#### K캼z캼l Akbaba

![[Coloured figures of the birds of the British Islands. v.1 \| London :R. H. Porter,1885-1897.](https://biodiversitylibrary.org/page/34514933)](figs/griffon.jpg)

K캼z캼l akbaba - _Gyps fulvus_ da da륿ar캼 tercih eden ve kayal캼klarda yuvalayan bir t칲r. K캼z캼l akbaba, sakall캼 akbaba kadar 칞ekingen olmayan, genellikle koloni h칙linde ya르yan bir t칲r. 룔mdi de k캼z캼l akbaban캼n da캼l캼m캼na bir bakal캼m. Acaba nerelerden kay캼tlar gelmi!

```{r}
kizil <- ebird_sf |> 
  filter(`SCIENTIFIC NAME` == "Gyps fulvus")
```

```{r}
ggplot() +
  geom_sf(data = tr_il, aes()) +
  geom_sf(data = kizil, aes(), size = .7)

```

K캼z캼l akbaba da캼l캼m캼n캼n, 칲reme ve g칬칞 b칬lgelerinde yo릇nla르n bir 칬r칲nt칲 sergiledi를ni g칬rebiliyoruz.


### 5. Ku verisinin gruplan캼p 칬zetlenmesi

Biraz oyalanman캼n ard캼ndan tekrardan sorumuza odaklanabiliriz. 칐ncelikle T칲rkiye'deki ku t칲rlerini ve her t칲rden ka칞 adet kay캼t oldu릇nu g칬rmek i칞in ku verisini t칲r ismine g칬re gruplay캼p, kay캼t say캼s캼na g칬re 칬zetleyelim. Bu i륿em biraz uzun s칲rebilir.

```{r}
ebird_grouped <- ebird_sf |>
  group_by(`SCIENTIFIC NAME`) |>
  summarise(n = n())
print(ebird_grouped)
```

```{r}
glimpse(ebird_grouped)
```

G칬rd칲칲n칲z gibi eBird veri taban캼nda T칲rkiye'den kay캼tl캼 503 t칲r varm캼. eBird'칲n internet sitesinde ise 494 adet t칲r g칬steriyor. Bu farkl캼l캼캼n sebebi nedir bilmiyorum dorusu. Akl캼ma, kesin olmayan baz캼 kay캼tlar캼n da olabilece를 geliyor sadece. Bilenler a칞캼klayabilirse s칲per olur.

### 6. Her bir il s캼n캼r캼 i칞inde kalan t칲r say캼s캼n캼n hesaplanmas캼

룔mdi, T칲rkiye'deki her bir ilin s캼n캼rlar캼 i칞ine d칲른n ku g칬zlem noktalar캼n캼 sayaca캼z. Yani her bir poligonun i칞indeki noktalar캼 sayaca캼z. Bu da bize her bir ildeki toplam t칲r say캼s캼n캼 verecek. 칐ncelikle [st_intersects()](https://r-spatial.github.io/sf/reference/geos_binary_pred.html) fonksiyonu ile her bir il ile kesi른n noktalar캼 belirliyoruz. Ard캼ndan [lengths()](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/lengths) fonksiyonu ile her bir ilde ka칞 adet nokta oldu릇nu hesapl캼yoruz ve bunu, tr_il verisine yeni bir s칲tun olarak ekliyoruz. Temelde 칞ok basit bir i륿em ama ba릆a anlamak zor olabiliyor.

```{r}
tr_il$bird_count <- lengths(st_intersects(tr_il, ebird_grouped))
```

### 7. Verinin g칬rselle릆irilmesi

룔mdi, h캼zl캼ca bir plotlayal캼m. Bunun i칞in plot() fonksiyonunu kullaca캼z. tr_il i칞indeki bird_count s칲tununu se칞elim.

```{r}
plot(tr_il[, "bird_count"])
```

Haritam캼z haz캼r. 룔mdi daha iyi bir g칬rselle릆irme i칞in ggplot() fonksiyonunu kullanal캼m.

칐ncelikle k캼r캼l캼mlar캼m캼z캼 belirleyelim ki haritam캼z daha g칲zel g칬r칲ns칲n. Bunun i칞in [jenks optimizasyonunu](https://en.wikipedia.org/wiki/Jenks_natural_breaks_optimization) kullanaca캼z.

```{r}
breaks <- classInt::classIntervals(
  tr_il$bird_count,
  n = 7,
  style = "jenks"
)
```

```{r}
ggplot() +                                     # grafigi baslatiyor
  geom_sf(
    data = tr_il,                              # tr katmanini ekliyoruz
    aes(fill = bird_count),                    # renkleri kus turu sayisina gore seciyoruz
    colour = "grey12",                         # il sinirlarinin rengini belirliyoruz
    linewidth = .1                             # il sinirlarinin kalinligini belirliyoruz
  ) +
  scale_fill_viridis_c(breaks = breaks$brks) + # haritamizi viridis paletiyle dolduruyoruz
  guides(                                      # lejant ozelliklerini seciyoruz
    fill = guide_colorsteps(
      barwidth = 20,
      barheight = .5,
      title.position = "right"
    )
  ) +
  labs(                                        # etiketleri yaziyoruz
    title = "캻llere G칬re Ku T칲r칲 Say캼s캼",
    x = "Boylam",
    y = "Enlem"
  ) +
  theme_bw() +                                 # tema seciyoruz
  theme(                                       # teman캼n ozellliklerini berlirliyoruz
    legend.position = "bottom",
    plot.background = element_rect("white", colour = "white"),
    text = element_text(family = "Ubuntu Mono"),
    legend.title = element_blank()
  )
```

G칬rd칲칲n칲z gibi 칞ok daha iyi bir g칬rselle릆irme oldu. 룟 an elimizde, T칲rkiye'deki illere g칬re ku t칲r칲 say캼s캼n캼 g칬steren bir harita bulunmakta. Ancak bu harita 칲zerinden yapaca캼m캼z yorumlarda dikkatli olmam캼z gereken birka칞 칬nemli nokta var. 캻l y칲z칬l칞칲m칲n칲n ve illere g칬re g칬zlem say캼s캼n캼n farkl캼 olmas캼ndan kaynaklanan yanl캼l캼k (bias) potansiyeli. Bu harita genel fikirler verebilir ancak net 칞캼kar캼mlar i칞in verinin standartla릆캼r캼lmas캼 ve istatistiki testlere tabi tutulmas캼 칬nem arz etmektedir.

캻kinci yaz캼da g칬r칲릀ek dile를yle.

Bilimle ve huzurla kal캼n캼z.
